/*
 * File: app/view/windowGenerarViewController.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('cartera.view.windowGenerarViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.windowgenerar',

    onbtnGuardar: function(button, e, eOpts) {
        var record1, record2, store;
        var data_jsonAr = [];
        var ctrl = this,
            storeGenerar = Ext.getStore("GenerarStore"),
            record;
        // rec;
        record = storeGenerar;

        var existe= Ext.getCmp("exis").checked;
        var todos= Ext.getCmp("todos").checked;
        var fisico = Ext.getCmp('fisico').getValue();
        var p = Ext.getCmp('proBar', {
            renderTo: Ext.getBody(),
            width: 300
        });


        p.wait({
            interval: 500, //bar will move fast!
            duration: 100,
            increment: 15,
            text: 'Generando Archivo...',
            scope: this,
            fn: function(){
                p.updateText('Espere un momento!!!!');
            }
        });


        //Ext.Ajax.request({
        //clientValidation: true,
        //url: 'api/config/validaArch',
        //method: "POST",
        Ext.getStore('ConfigStore').load({
            callback: function (records, operation, success){

                //var x = Ext.getStore('ConfigStore').data.items[0];


                //console.log(records[0].data.nom_usuario);

                if(success === true){
                    console.log(success);
                    Ext.Ajax.request({
                        clientValidation: true,
                        url: 'api/generar/crearArch',
                        method: "POST",
                        params: {
                            existe: existe,
                            todos: todos,
                            nombre: Ext._nombre,
                            id_usuario: Ext._idusr

                        },
                        success: function(rec, op) {

                            Ext.MessageBox.show({
                                title: 'Archivo Fisico',
                                icon: Ext.MessageBox.WARNING,
                                msg: 'Archivo Generado con Ã©xito...',
                                buttons: Ext.MessageBox.OK
                            });
                            button.up('window').close();

                        },

                        failure: function(rec, op) {
                            Ext.MessageBox.show({
                                title: 'Archivo Fisico',
                                icon: Ext.MessageBox.INFO,
                                msg: 'No se pudo Generar el Archivo!!!.',
                                buttons: Ext.MessageBox.OK
                            });
                        }


                    });

                }else{
                    nombre_usuario = records[0].data.nom_usuario;
                    fecha_fisico   = records[0].data.fecha_fisico;
                    fecha_fisico = Ext.Date.format(fecha_fisico, 'F j, Y, g:i a');
                    Ext.MessageBox.show({
                        title: 'Login',
                        icon: Ext.MessageBox.INFO,
                        msg: 'Ya existe un archivo con fecha '+fecha_fisico+' Generado por '+nombre_usuario,
                        buttons: Ext.MessageBox.OK
                    });
                    button.up('window').close();


                }

            }


        });



        /*  */




    },

    onbtnCancelar: function(button, e, eOpts) {
        button.up('window').close();
    },

    onFormGenArchAfterRender: function(component, eOpts) {
        var dt = new Date();
        var fecha  = Ext.Date.format(dt, 'F j, Y, g:i a');
        var mes    = Ext.Date.format(dt, 'm');
        var ano    = Ext.Date.format(dt, 'y');
        var fisico = 'FICF'+mes+ano;
        Ext.getCmp('fecha').setValue(fecha);
        Ext.getCmp('fisico').setValue(fisico);
    }

});
