/*
 * File: app/view/InstitucionesWinViewController.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('cartera.view.InstitucionesWinViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.institucioneswin1',

    onInstitucionescmbChange: function(field, newValue, oldValue, eOpts) {
        var lengthRecord = field.lastSelectedRecords,
            form = Ext.getCmp('institucionesForm'),
            formCmb = Ext.getCmp('comboForm');
        //console.log(lengthRecord);
        if(lengthRecord !== null){
            Ext.getStore('BuscarInsStore').load({
                params:{
                    'id_institucion':field.lastSelectedRecords[0].data.id_institucion
                },
                callback: function(records) {
                    if (records.length > 0) {
                        form.getForm().loadRecord(records[0]);
                    } else {
                        form.reset();
                    }
                    Ext.getCmp('id_institucion').setValue(field.lastSelectedRecords[0].data.id_institucion);
                    var imagen = records[0].data.ruta_logo;
                    if (imagen!==""){
                        Ext.getCmp('imglogo').setSrc("api/webroot/"+imagen);
                    }else{
                        Ext.getCmp('imglogo').setSrc("api/webroot/sinfoto.png");
                    }
                    //Ext.getCmp('imgEmp').setSrc('cakephp/app/webroot/'+record.data.foto_per);
                    /* var changingImage = Ext.create('Ext.Img', {
                    src: "api/webroot/"+imagen,
                    width: 100,
                    height: 100,
                    renderTo: Ext.getBody()
                    });*/

                }
            });
        }

    },

    onRfcChange: function(field, newValue, oldValue, eOpts) {
        field.setValue(newValue.toUpperCase());
    },

    onCalleChange: function(field, newValue, oldValue, eOpts) {
        field.setValue(newValue.toUpperCase());
    },

    onColoniaChange: function(field, newValue, oldValue, eOpts) {
        field.setValue(newValue.toUpperCase());
    },

    onRazon_socialChange: function(field, newValue, oldValue, eOpts) {
        field.setValue(newValue.toUpperCase());
    },

    onNo_exteriorChange: function(field, newValue, oldValue, eOpts) {
        field.setValue(newValue.toUpperCase());
    },

    onNo_interiorChange: function(field, newValue, oldValue, eOpts) {
        field.setValue(newValue.toUpperCase());
    },

    onFilefieldAfterRender: function(component, eOpts) {
        component.fileInputEl.set({
            accept:  '.jpeg, .png, .jpg'
        });
    },

    onFilefieldChange: function(filefield, value, eOpts) {
        alert(value);
        if(value === ''){
            Ext.getCmp('txtImagen').setValue(0);
            console.log(Ext.getCmp('txtImagen').getValue());
        }else{
            Ext.getCmp('txtImagen').setValue(1);
            console.log(Ext.getCmp('txtImagen').getValue());
        }
    },

    onbtnGuardar: function(button, e, eOpts) {
        var win = button.up('window'),
            form   = Ext.getCmp('institucionesForm'),
            record = form.getRecord(),
            values = form.getValues();

        console.log(record);
        console.log(values.id_institucion_dato);
        if(form.isValid()){
            if(values.id_institucion_dato>0){
                //Modificar Institución.
                //var recordLogin = Ext.getStore('StoreLogin').data.items[0];
                //values.id_usuarioAct = recordLogin.data.id_usuario;
                //record.set(values);
                //Ext.getStore('DatosStore').sync();
                form.submit({
                    params: Ext.JSON.encode(values),
                    url: 'api/datos/agregarDatos',
                    waitMsg: 'Procesando información...',
                    success: function() {


                        Ext.MessageBox.show({
                            title : 'Información',
                            buttons : Ext.MessageBox.OK,
                            msg : 'Institución '+values.razon_social+' ha sido actualizada.',
                            icon : Ext.Msg.INFO

                        });
                        Ext.getStore('DatosStore').load();
                        win.close();
                    },
                    failure: function() {
                        console.log('FAILURE CAPTURA INSTITUCION');
                    }
                });
                /* Ext.MessageBox.show({
                title : 'Advertencia',
                buttons : Ext.MessageBox.OK,
                msg : 'Institución Actualizada con Éxito. Verifique...',
                icon : Ext.Msg.INFO
                }); */
            }else{
                //Agregar Institución.
                if(Ext.getStore('DatosStore').findExact('rfc', values.rfc)!=-1){
                    Ext.MessageBox.show({
                        title : 'Advertencia',
                        buttons : Ext.MessageBox.OK,
                        msg : 'Ya Existe una Institución con el RFC: '+values.rfc+'. Verifique...',
                        icon : Ext.Msg.ERROR
                    });
                }else{
                    // var recordLogin = Ext.getStore('StoreLogin').data.items[0];
                    //values.id_usuarioAct = recordLogin.data.id_usuario;
                    record = Ext.create('cartera.model.DatosModel');
                    console.log(record);
                    record.set(values);
                    //Ext.getStore('DatosStore').add(record);
                    // Ext.getStore('DatosStore').sync();
                    form.submit({
                        params: Ext.JSON.encode(values),
                        url: 'api/datos/agregarDatos',
                        waitMsg: 'Procesando información...',
                        success: function() {


                            Ext.MessageBox.show({
                                title : 'Información',
                                buttons : Ext.MessageBox.OK,
                                msg : 'Institución '+values.razon_social+' ha sido agregada.',
                                icon : Ext.Msg.INFO

                            });
                            Ext.getStore('DatosStore').load();
                            win.close();
                        },
                        failure: function() {
                            console.log('FAILURE CAPTURA INSTITUCION');
                        }
                    });
                    /* Ext.MessageBox.show({
                    title : 'Advertencia',
                    buttons : Ext.MessageBox.OK,
                    msg : 'Institución Agregada con Éxito',
                    icon : Ext.Msg.INFO
                    });
                    win.close();*/
                }
            }

        }else{
            //Si el formulario no es válido
            Ext.MessageBox.show({
                title : 'Atencion',
                buttons : Ext.MessageBox.OK,
                msg : 'Ingrese todos los campos obligatorios',
                icon : Ext.Msg.ERROR
            });
        }
    },

    onbtnCancelar: function(button, e, eOpts) {
        button.up('window').close();
    },

    onWinGen1AfterRender: function(component, eOpts) {

    }

});
