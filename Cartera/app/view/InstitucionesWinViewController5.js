/*
 * File: app/view/InstitucionesWinViewController5.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('cartera.view.InstitucionesWinViewController5', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.promocionesinswin',

    onDescuentoChange: function(field, newValue, oldValue, eOpts) {
        var CuotaIns = Ext.getCmp('cuotaPI').getValue(),
            CuotaDes = 0,
            Por_desc = newValue;

        console.log(Por_desc);
        CuotaDes = CuotaIns * ((100-newValue)/100);
        CuotaDes=Ext.util.Format.round(CuotaDes,0);
        Ext.getCmp('cuota_descuento').setValue(CuotaDes);
    },

    onbtnGuardarPI: function(button, e, eOpts) {
        var win = button.up('window'),
            form   = Ext.getCmp('formPromocionesIns'),
            record = form.getRecord(),
            values = form.getValues();
        fecha_ini = Ext.getCmp('fecha_inicio').getValue();
        fecha_fin = Ext.getCmp('fecha_fin').getValue();

        if(fecha_ini<=fecha_fin){


            //console.log(form);
            console.log(values.id_descuento_inscripcion);
            if(form.isValid()){
                if(values.id_descuento_inscripcion>0){
                    //Modificar Forma de Pago.
                    //var recordLogin = Ext.getStore('StoreLogin').data.items[0];
                    //values.id_usuarioAct = recordLogin.data.id_usuario;
                    // record.set(values);
                    // Ext.getStore('FormasPagoStore').sync();
                    form.submit({
                        params: Ext.JSON.encode(values),
                        url: 'api/promocionesins/actualiza',
                        waitMsg: 'Procesando información...',
                        success: function() {


                            Ext.MessageBox.show({
                                title : 'Información',
                                buttons : Ext.MessageBox.OK,
                                msg : 'Cuota de Inscripcion para '+values.descripcion+' ha sido actualizada.',
                                icon : Ext.Msg.INFO

                            });
                            Ext.getStore('PromocionesInsStore').load({
                                params:{
                                    'id_ins': Ext._id_institucion,
                                    'id_ciclo_escolar': Ext._id_ciclo_escolar,
                                    'id_cuota_inscripcion': record.data.id_cuota_inscripcion
                                },
                            });


                            win.close();
                        },
                        failure: function() {
                            console.log('FAILURE CAPTURA PROMOCION');
                        }
                    });
                }else{
                    //Agregar Institución.
                    if(Ext.getStore('PromocionesInsStore').findExact('descuento', parseInt(values.descuento))!=-1){
                        Ext.MessageBox.show({
                            title : 'Advertencia',
                            buttons : Ext.MessageBox.OK,
                            msg : 'Ya Existe Cuota para: %'+values.descuento+'. Verifique...',
                            icon : Ext.Msg.ERROR
                        });
                    }else{
                        // var recordLogin = Ext.getStore('StoreLogin').data.items[0];
                        //values.id_usuarioAct = recordLogin.data.id_usuario;
                        record = Ext.create('cartera.model.PromocionesInsModel');
                        console.log(record);
                        record.set(values);
                        //Ext.getStore('FormasPagoStore').add(record);
                        //Ext.getStore('FormasPagoStore').sync();
                        //Ext.getCmp('id_insCI').setValue(Ext._id_institucion);
                        form.submit({
                            params: Ext.JSON.encode(values),
                            url: 'api/promocionesins/create',
                            waitMsg: 'Procesando información...',
                            success: function() {


                                Ext.MessageBox.show({
                                    title : 'Información',
                                    buttons : Ext.MessageBox.OK,
                                    msg : 'Promocion ha sido agregada.',
                                    icon : Ext.Msg.INFO

                                });
                                console.log(record.data.id_cuota_inscripcion);
                                Ext.getStore('PromocionesInsStore').load({
                                    params:{
                                        'id_ins': Ext._id_institucion,
                                        'id_ciclo_escolar': Ext._id_ciclo_escolar,
                                        'id_cuota_inscripcion': record.data.id_cuota_inscripcion
                                    },
                                });

                                win.close();
                            },
                            failure: function() {
                                console.log('FAILURE CAPTURA PROMOCION');
                            }
                        });


                    }
                }

            }else{
                //Si el formulario no es válido
                Ext.MessageBox.show({
                    title : 'Atencion',
                    buttons : Ext.MessageBox.OK,
                    msg : 'Ingrese todos los campos obligatorios',
                    icon : Ext.Msg.ERROR
                });
            }
        }else{
            Ext.MessageBox.show({
                title : 'Atencion',
                buttons : Ext.MessageBox.OK,
                msg : 'Ingrese la fecha correctamente',
                icon : Ext.Msg.ERROR
            });
        }
    },

    onbtnCancelarPI: function(button, e, eOpts) {
        button.up('window').close();
    },

    onPromocionesInsWinAfterRender: function(component, eOpts) {
        //Ext.getCmp('id_insCI').setValue(Ext._id_institucion);
        //Ext.getCmp('id_ciclo_escolar').setValue(Ext._id_ciclo_escolar);
        Ext.getStore('EstatusIngresosStore').load();
    }

});
