/*
 * File: app/view/InstitucionesWinViewController15.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('cartera.view.InstitucionesWinViewController15', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.referenciaswin',

    onbtnGuardarRef: function(button, e, eOpts) {
        var win = button.up('window'),
            form   = Ext.getCmp('formReferencias'),
            record = form.getRecord(),
            values = form.getValues();




        //AGREGAR REFERENCIAS

        //AGREGAR REFERENCIAS A TODOS LOS ALUMNOS


        if(Ext.getCmp('rbtSelecRef').getValue()===true){

            //Agregar Estatus Ingreso.
            if(Ext.getStore('ReferenciasStore').findExact('id_alumno', parseInt(values.id_alumno))!=-1){
                Ext.MessageBox.show({
                    title : 'Advertencia',
                    buttons : Ext.MessageBox.OK,
                    msg : 'Ya existen datos para ese alumno. Verifique...',
                    icon : Ext.Msg.ERROR
                });
            }else{

                record = Ext.create('cartera.model.ReferenciasModel');
                console.log(record);
                record.set(values);
                form.submit({
                    params: Ext.JSON.encode(values),
                    url: 'api/referencias/create',
                    waitMsg: 'Procesando informaci贸n...',
                    success: function() {


                        Ext.MessageBox.show({
                            title : 'Informaci贸n',
                            buttons : Ext.MessageBox.OK,
                            msg : 'El carnet se ha generado',
                            icon : Ext.Msg.INFO

                        });


                        Ext.getStore('ReferenciasStore').load({
                            params:{
                                'id_alumno': record.data.id_alumno,
                                'id_institucion': Ext._id_institucion


                            }
                        });


                        win.close();
                    },
                    failure: function() {
                    }
                });
            }

        }else{
            // AGREGAR REFENCIAS PARA EL ALUMNO SELECCIONADO

            record = Ext.create('cartera.model.ReferenciasModel');
            console.log(record);
            record.set(values);
            form.submit({
                params: Ext.JSON.encode(values),
                url: 'api/referencias/createall',
                waitMsg: 'Procesando informaci贸n...',
                success: function() {


                    Ext.MessageBox.show({
                        title : 'Informaci贸n',
                        buttons : Ext.MessageBox.OK,
                        msg : 'El carnet se ha generado',
                        icon : Ext.Msg.INFO

                    });


                    Ext.getStore('ReferenciasStore').load({
                        params:{
                            'id_alumno': record.data.id_alumno,
                            'id_institucion': Ext._id_institucion

                        }
                    });

                    win.close();
                },
                failure: function() {

                }
            });


        }



    },

    onbtnCancelarRef: function(button, e, eOpts) {
        button.up('window').close();
    },

    onCarnetsWinAfterRender: function(component, eOpts) {


        Ext.getStore('CarnetsAlumnosStore').load({
            params:{
                'id_ins': Ext._id_institucion,
                'id_ciclo_escolar': Ext._id_ciclo_escolar,
                'id_cuota_inscripcion': Ext._id_cuota_inscripcion
            },
        });



        Ext.getStore('cmbMesesCicloStore').load({
            params:{
                'id_ins': Ext._id_institucion

            },
        });



    }

});
